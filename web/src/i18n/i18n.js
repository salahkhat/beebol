import { createContext, useCallback, useContext, useEffect, useMemo, useState } from 'react';

const STORAGE_KEY = 'beebol.locale';

const STRINGS = {
  ar: {
    appName: 'بيبول',
    menu: 'القائمة',
    account: 'الحساب',
    nav_listings: 'الإعلانات',
    nav_create: 'إضافة إعلان',
    nav_my: 'إعلاناتي',
    nav_messages: 'الرسائل',
    nav_moderation: 'الإشراف',
    login: 'تسجيل الدخول',
    register: 'إنشاء حساب',
    logout: 'تسجيل الخروج',
    back: 'رجوع',
    notFound: 'الصفحة غير موجودة',
    unexpected_error: 'حدث خطأ غير متوقع. حاول تحديث الصفحة.',
    reload: 'تحديث',
    skip_to_content: 'تخطي إلى المحتوى',
    theme_dark: 'الوضع الداكن',
    theme_light: 'الوضع الفاتح',
    favorite_add: 'إضافة للمفضلة',
    favorite_remove: 'إزالة من المفضلة',
    recently_viewed: 'شوهدت مؤخراً',
    copy_link: 'نسخ الرابط',
    copied: 'تم النسخ',
    copy_link_done: 'تم نسخ رابط الإعلان',
    copy_link_failed: 'تعذر نسخ الرابط',
    copy_link_prompt: 'انسخ الرابط:',
    login_to_message: 'سجّل الدخول للمراسلة',

    listings_title: 'الإعلانات',
    listings_search_placeholder: 'ابحث…',
    listings_sort: 'الترتيب',
    listings_category: 'التصنيف',
    listings_governorate: 'المحافظة',
    listings_city: 'المدينة',
    listings_neighborhood: 'الحي',
    listings_none: 'لا توجد إعلانات',
    listings_showing: 'عرض {shown} من {count}',
    prev: 'السابق',
    next: 'التالي',
    clear_filters: 'مسح الفلاتر',
    retry: 'إعادة المحاولة',
    select_placeholder: 'اختر…',
    none: 'لا يوجد',
    loading: 'جاري التحميل…',
    invalid: 'غير صالح',
    required: 'مطلوب',
    page: 'الصفحة',
    listings_total: 'الإجمالي',
    sort_newest: 'الأحدث',
    sort_oldest: 'الأقدم',
    sort_price_low: 'السعر: الأقل',
    sort_price_high: 'السعر: الأعلى',

    detail_seller: 'البائع',
    detail_location: 'الموقع',
    detail_created: 'تاريخ الإضافة',
    detail_messageSeller: 'راسل البائع',
    detail_manage: 'إدارة الإعلان',
    detail_images: 'الصور',
    detail_openImage: 'فتح الصورة',
    detail_noDescription: 'لا يوجد وصف',
    detail_dragToReorder: 'اسحب الصور لإعادة ترتيبها.',
    detail_uploadImage: 'رفع صورة جديدة',
    detail_upload: 'رفع',
    detail_noImages: 'لا توجد صور بعد',
    detail_questions: 'الأسئلة',
    detail_noQuestions: 'لا توجد أسئلة بعد',
    detail_unanswered: 'لم يتم الرد بعد',
    detail_askQuestion: 'اكتب سؤالك',
    detail_sendQuestion: 'إرسال السؤال',
    detail_loginToAsk: 'سجّل الدخول لطرح سؤال',
    detail_answerPrompt: 'أضف إجابة',
    detail_saveAnswer: 'حفظ الإجابة',
    save: 'حفظ',
    edit: 'تعديل',
    toast_reorderSaved: 'تم حفظ ترتيب الصور',
    toast_reorderFailed: 'تعذر حفظ ترتيب الصور',
    toast_saved: 'تم الحفظ',
    toast_uploaded: 'تم رفع الصورة',
    toast_uploadFailed: 'تعذر رفع الصورة',
    toast_questionSent: 'تم إرسال السؤال',
    toast_answerSaved: 'تم حفظ الإجابة',
    detail_deleteImageConfirm: 'هل تريد حذف هذه الصورة؟',
    toast_imageDeleted: 'تم حذف الصورة',
    toast_imageDeleteFailed: 'تعذر حذف الصورة',

    auth_login_title: 'تسجيل الدخول',
    auth_register_title: 'إنشاء حساب',
    auth_username: 'اسم المستخدم',
    auth_email_optional: 'البريد الإلكتروني (اختياري)',
    auth_password: 'كلمة المرور',
    auth_password_hint: 'يجب أن تكون كلمة المرور 8 أحرف على الأقل.',
    auth_noAccount: 'ليس لديك حساب؟',
    auth_haveAccount: 'لديك حساب؟',

    create_title: 'إضافة إعلان',
    create_hint: 'الإعلانات الجديدة تكون بانتظار الموافقة.',
    create_title_label: 'العنوان',
    create_description_label: 'الوصف',
    create_price: 'السعر',
    create_currency: 'العملة',
    create_status: 'الحالة',
    status_draft: 'مسودة',
    status_published: 'منشور',
    status_archived: 'مؤرشف',
    create_neighborhood_optional: 'الحي (اختياري)',
    create_step: 'الخطوة {current} من {total}',
    create_step_basic: 'المعلومات الأساسية',
    create_step_pricing: 'السعر والحالة',
    create_step_location: 'الموقع',
    create_step_photos: 'الصور',
    create_step_review: 'مراجعة',
    create_photos_add: 'إضافة صور',
    create_photos_optional: 'الصور (اختياري)',
    create_photos_help: 'يمكنك اختيار عدة صور. سيتم رفعها بعد إنشاء الإعلان.',
    create_photos_reorder_help: 'اسحب الصور لإعادة ترتيبها.',
    create_photos_alt_optional: 'وصف الصورة (اختياري)',
    remove: 'إزالة',
    move_up: 'للأعلى',
    move_down: 'للأسفل',
    review: 'مراجعة',
    create_submit_and_upload: 'إنشاء ورفع الصور',
    create_submit: 'إضافة',

    draft_save: 'حفظ كمسودة',
    draft_saved: 'تم حفظ المسودة',
    draft_restore_prompt: 'تم العثور على مسودة محفوظة. هل تريد استعادتها؟',
    draft_restore: 'استعادة المسودة',
    draft_restored: 'تمت استعادة المسودة',
    draft_discard: 'حذف المسودة',
    draft_discard_confirm: 'هل تريد حذف المسودة المحفوظة؟',
    draft_discarded: 'تم حذف المسودة',
    draft_saved_at: 'آخر حفظ:',
    draft_photos_note: 'كانت هناك {count} صور محددة في المسودة، لكن يجب إعادة اختيارها بعد إعادة التحميل.',

    my_title: 'إعلاناتي',
    my_createNew: 'إضافة إعلان جديد',
    my_empty: 'لا توجد إعلانات بعد',
    my_hint: 'يعرض إعلاناتك (بما فيها بانتظار الموافقة).',
    my_quickEdit: 'تعديل سريع',
    my_status: 'الحالة',
    my_selectAll: 'تحديد الكل',
    my_selectedCount: 'المحدد: {count}',
    my_bulkUpdate: 'تعديل جماعي',
    my_bulkStatus: 'الحالة الجماعية',
    my_apply: 'تطبيق',
    my_clearSelection: 'مسح التحديد',
    my_selectListing: 'تحديد الإعلان رقم {id}',
    toast_bulkPartial: 'تم تحديث {ok} من {total}.',

    messages_title: 'الرسائل',
    messages_threads: 'محادثاتك',
    messages_empty: 'لا توجد محادثات بعد',
    messages_lastMessage: 'آخر رسالة',
    messages_noMessagesYet: 'لا توجد رسائل بعد',
    messages_unread: 'جديد',
    messages_typePlaceholder: 'اكتب رسالة',
    toast_threadCreated: 'تم إنشاء المحادثة',
    toast_openingMessages: 'جارٍ فتح الرسائل…',
    toast_couldNotMessageSeller: 'تعذر مراسلة البائع',
    toast_sendFailed: 'فشل الإرسال',
    toast_moderationStatus: 'حالة الإشراف: {status}',
    toast_moderationChanged: 'تم تحديث الإشراف على الإعلان رقم {id} إلى {status}',
    send: 'إرسال',
    refresh: 'تحديث',

    thread_title: 'محادثة رقم {id}',
    listing_number: 'إعلان رقم {id}',
    user_number: 'المستخدم رقم {id}',

    moderation_status_pending: 'قيد المراجعة',
    moderation_status_approved: 'مقبول',
    moderation_status_rejected: 'مرفوض',

    moderation_dialog_listing: 'إعلان رقم {id}: {title}',
  moderation_dialog_bulk: 'سيتم تطبيق هذا الإجراء على {count} إعلان.',
  mod_showDetails: 'عرض التفاصيل',
  mod_hideDetails: 'إخفاء التفاصيل',
  mod_detailsLoadFailed: 'تعذر تحميل التفاصيل',
  toast_moderationBulkChanged: 'تم تحديث {count} إعلان إلى {status}',
  toast_moderationBulkPartial: 'تم تحديث {ok} من {total} إلى {status}',

    moderation_title: 'الإشراف',
    moderation_pending: 'إعلانات بانتظار الموافقة',
    moderation_removed: 'إعلانات محذوفة',
    mod_showRemoved: 'عرض المحذوف',
    mod_showFlagged: 'عرض المعلّم',
    flag: 'وضع علامة',
    unflag: 'إزالة العلامة',
    flagged: 'معلّم',
    unflagged: 'غير معلّم',
    approve: 'موافقة',
    reject: 'رفض',
    cancel: 'إلغاء',
    confirm: 'تأكيد',
    moderate_approve_title: 'تأكيد الموافقة؟',
    moderate_reject_title: 'تأكيد الرفض؟',
    moderate_remove_title: 'تأكيد الإزالة؟',
    moderate_restore_title: 'تأكيد الاستعادة؟',
    moderation_dialog_help: 'سيؤدي ذلك إلى تغيير حالة الإشراف على الإعلان.',
    moderation_remove_help: 'سيؤدي ذلك إلى إزالة الإعلان وإخفائه عن الجميع.',
    moderation_restore_help: 'سيؤدي ذلك إلى استعادة الإعلان وإظهاره مجدداً.',
    mod_bulkFlag: 'وضع علامة للمحدد',
    mod_bulkUnflag: 'إزالة علامة المحدد',
    mod_bulkRemove: 'إزالة المحدد',
    mod_bulkRestore: 'استعادة المحدد',
    restore: 'استعادة',
    toast_moderationFlagged: 'تم تحديث {count} إعلان: {state}',
    toast_moderationFlaggedPartial: 'تم تحديث {ok} من {total}: {state}',
    toast_moderationRemoved: 'تم إزالة {count} إعلان',
    toast_moderationRemovedPartial: 'تم إزالة {ok} من {total}',
    toast_moderationRestored: 'تمت استعادة {count} إعلان',
    toast_moderationRestoredPartial: 'تمت استعادة {ok} من {total}',
  },
  en: {
    appName: 'Beebol',
    menu: 'Menu',
    account: 'Account',
    nav_listings: 'Listings',
    nav_create: 'Create',
    nav_my: 'My listings',
    nav_messages: 'Messages',
    nav_moderation: 'Moderation',
    login: 'Login',
    register: 'Register',
    logout: 'Logout',
    back: 'Back',
    notFound: 'Page not found',
    unexpected_error: 'Something went wrong. Try reloading the page.',
    reload: 'Reload',
    skip_to_content: 'Skip to content',
    theme_dark: 'Dark mode',
    theme_light: 'Light mode',
    favorite_add: 'Add to favorites',
    favorite_remove: 'Remove from favorites',
    recently_viewed: 'Recently viewed',
    copy_link: 'Copy link',
    copied: 'Copied',
    copy_link_done: 'Listing link copied',
    copy_link_failed: 'Could not copy link',
    copy_link_prompt: 'Copy this link:',
    login_to_message: 'Login to message',

    listings_title: 'Listings',
    listings_search_placeholder: 'Search…',
    listings_sort: 'Sort',
    listings_category: 'Category',
    listings_governorate: 'Governorate',
    listings_city: 'City',
    listings_neighborhood: 'Neighborhood',
    listings_none: 'No listings found.',
    listings_showing: 'Showing {shown} of {count}',
    prev: 'Prev',
    next: 'Next',
    clear_filters: 'Clear filters',
    retry: 'Retry',
    select_placeholder: 'Select…',
    none: 'None',
    loading: 'Loading…',
    invalid: 'Invalid',
    required: 'Required',
    page: 'Page',
    listings_total: 'total',
    sort_newest: 'Newest',
    sort_oldest: 'Oldest',
    sort_price_low: 'Price: low',
    sort_price_high: 'Price: high',

    detail_seller: 'Seller',
    detail_location: 'Location',
    detail_created: 'Created',
    detail_messageSeller: 'Message seller',
    detail_manage: 'Manage listing',
    detail_images: 'Images',
    detail_openImage: 'Open image',
    detail_noDescription: 'No description.',
    detail_dragToReorder: 'Drag photos to reorder.',
    detail_uploadImage: 'Upload a new image',
    detail_upload: 'Upload',
    detail_noImages: 'No images yet',
    detail_questions: 'Questions',
    detail_noQuestions: 'No questions yet',
    detail_unanswered: 'Not answered yet',
    detail_askQuestion: 'Ask a question',
    detail_sendQuestion: 'Send question',
    detail_loginToAsk: 'Login to ask a question',
    detail_answerPrompt: 'Add an answer',
    detail_saveAnswer: 'Save answer',
    save: 'Save',
    edit: 'Edit',
    toast_reorderSaved: 'Photo order saved',
    toast_reorderFailed: 'Could not save photo order',
    toast_saved: 'Saved',
    toast_uploaded: 'Image uploaded',
    toast_uploadFailed: 'Could not upload image',
    toast_questionSent: 'Question sent',
    toast_answerSaved: 'Answer saved',

    auth_login_title: 'Login',
    auth_register_title: 'Register',
    auth_username: 'Username',
    auth_email_optional: 'Email (optional)',
    auth_password: 'Password',
    auth_password_hint: 'Password must be at least 8 characters.',
    auth_noAccount: "Don't have an account?",
    auth_haveAccount: 'Already have an account?',

    create_title: 'Create listing',
    create_hint: 'New listings start as pending moderation.',
    create_title_label: 'Title',
    create_description_label: 'Description',
    create_price: 'Price',
    create_currency: 'Currency',
    create_status: 'Status',
    status_draft: 'Draft',
    status_published: 'Published',
    status_archived: 'Archived',
    create_neighborhood_optional: 'Neighborhood (optional)',
    create_step: 'Step {current} of {total}',
    create_step_basic: 'Basic info',
    create_step_pricing: 'Pricing & status',
    create_step_location: 'Location',
    create_step_photos: 'Photos',
    create_step_review: 'Review',
    create_photos_add: 'Add photos',
    create_photos_optional: 'Photos (optional)',
    create_photos_help: 'You can select multiple photos. They will upload after the listing is created.',
    create_photos_reorder_help: 'Drag photos to reorder them.',
    create_photos_alt_optional: 'Photo description (optional)',
    remove: 'Remove',
    move_up: 'Up',
    move_down: 'Down',
    review: 'Review',
    create_submit_and_upload: 'Create & upload photos',
    create_submit: 'Create',

    draft_save: 'Save draft',
    draft_saved: 'Draft saved',
    draft_restore_prompt: 'A saved draft was found. Restore it?',
    draft_restore: 'Restore draft',
    draft_restored: 'Draft restored',
    draft_discard: 'Discard draft',
    draft_discard_confirm: 'Discard the saved draft?',
    draft_discarded: 'Draft discarded',
    draft_saved_at: 'Last saved:',
    draft_photos_note: 'You had {count} selected photos in the draft, but you must re-select them after a refresh.',

    my_title: 'My listings',
    my_createNew: 'Create new',
    my_empty: 'No listings yet.',
    my_hint: 'Shows your listings (including pending moderation).',
    my_quickEdit: 'Quick edit',
    my_status: 'Status',
    my_selectAll: 'Select all',
    my_selectedCount: 'Selected: {count}',
    my_bulkUpdate: 'Bulk update',
    my_bulkStatus: 'Bulk status',
    my_apply: 'Apply',
    my_clearSelection: 'Clear selection',
    my_selectListing: 'Select listing #{id}',
    toast_bulkPartial: 'Updated {ok} of {total}.',

    messages_title: 'Messages',
    messages_threads: 'Your threads',
    messages_empty: 'No threads yet.',
    messages_lastMessage: 'Last message',
    messages_noMessagesYet: 'No messages yet',
    messages_unread: 'Unread',
    messages_typePlaceholder: 'Type a message',
    toast_threadCreated: 'Thread created',
    toast_openingMessages: 'Opening messages…',
    toast_couldNotMessageSeller: 'Could not message seller',
    toast_sendFailed: 'Send failed',
    toast_moderationStatus: 'Moderation: {status}',
    toast_moderationChanged: 'Listing #{id} → {status}',
    send: 'Send',
    refresh: 'Refresh',

    thread_title: 'Thread #{id}',
    listing_number: 'Listing #{id}',
    user_number: 'User #{id}',

    moderation_status_pending: 'pending',
    moderation_status_approved: 'approved',
    moderation_status_rejected: 'rejected',

    moderation_dialog_listing: 'Listing #{id}: {title}',
  moderation_dialog_bulk: 'This will apply to {count} listings.',
  toast_moderationBulkChanged: 'Updated {count} listings → {status}',
  toast_moderationBulkPartial: 'Updated {ok} of {total} → {status}',
  mod_selectAll: 'Select all',
  mod_selectedCount: 'Selected: {count}',
  mod_bulkApprove: 'Approve selected',
  mod_bulkReject: 'Reject selected',
  mod_clearSelection: 'Clear selection',
  mod_selectListing: 'Select listing #{id}',
  mod_showDetails: 'Show details',
  mod_hideDetails: 'Hide details',
  mod_detailsLoadFailed: 'Could not load details',

    moderation_title: 'Moderation',
    moderation_pending: 'Pending published listings',
    moderation_removed: 'Removed listings',
    mod_showRemoved: 'Show removed',
    mod_showFlagged: 'Show flagged',
    flag: 'Flag',
    unflag: 'Unflag',
    flagged: 'Flagged',
    unflagged: 'Unflagged',
    approve: 'Approve',
    reject: 'Reject',
    cancel: 'Cancel',
    confirm: 'Confirm',
    moderate_approve_title: 'Approve listing?',
    moderate_reject_title: 'Reject listing?',
    moderate_remove_title: 'Remove listing?',
    moderate_restore_title: 'Restore listing?',
    moderation_dialog_help: 'This changes the listing moderation status.',
    moderation_remove_help: 'This removes the listing and hides it from everyone.',
    moderation_restore_help: 'This restores the listing and makes it visible again.',
  mod_bulkFlag: 'Flag selected',
  mod_bulkUnflag: 'Unflag selected',
  mod_bulkRemove: 'Remove selected',
  mod_bulkRestore: 'Restore selected',
  restore: 'Restore',
  toast_moderationFlagged: 'Updated {count} listings: {state}',
  toast_moderationFlaggedPartial: 'Updated {ok} of {total}: {state}',
  toast_moderationRemoved: 'Removed {count} listings',
  toast_moderationRemovedPartial: 'Removed {ok} of {total}',
  toast_moderationRestored: 'Restored {count} listings',
  toast_moderationRestoredPartial: 'Restored {ok} of {total}',
  },
};

const DIR = { ar: 'rtl', en: 'ltr' };

const I18nCtx = createContext(null);

export function I18nProvider({ children, defaultLocale = 'ar' }) {
  const [locale, setLocale] = useState(() => {
    try {
      return localStorage.getItem(STORAGE_KEY) || defaultLocale;
    } catch {
      return defaultLocale;
    }
  });

  const dir = DIR[locale] || 'ltr';

  useEffect(() => {
    try {
      localStorage.setItem(STORAGE_KEY, locale);
    } catch {
      // ignore
    }
    document.documentElement.lang = locale;
    document.documentElement.dir = dir;
  }, [locale, dir]);

  const t = useCallback(
    (key, vars) => {
      const table = STRINGS[locale] || STRINGS.en;
      let out = table[key] || STRINGS.en[key] || key;
      if (vars && typeof out === 'string') {
        for (const [k, v] of Object.entries(vars)) {
          out = out.replaceAll(`{${k}}`, String(v));
        }
      }
      return out;
    },
    [locale],
  );

  const value = useMemo(() => ({ locale, dir, setLocale, t }), [locale, dir, t]);

  return <I18nCtx.Provider value={value}>{children}</I18nCtx.Provider>;
}

export function useI18n() {
  const ctx = useContext(I18nCtx);
  if (!ctx) throw new Error('useI18n must be used within I18nProvider');
  return ctx;
}
